<!doctype html>
<html>
<head>
  <title>Rough World Map</title>
</head>
<body>
    <svg id="overWorld"></circle></svg>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.13.0/d3.min.js"></script>
    <script>
        (function() {
            'use strict';
            d3.json("http://127.0.0.1:8080/api/v1/db/", function(error, keyList){
                if (error) {
                    return console.warn(error);
                }
                console.log("Key list retrieved");
                let chunkList = {};
                keyList.keys.forEach(function(e, i) {
                    // Matches overworld subchunks ................2f..
                    if (/^[\da-f]{16}2f[\da-f]{2}/.test(e.hexKey)) {
                        let myChunk = e.hexKey.substring(0,16);
                        if (chunkList[myChunk]) {
                            // If it exists, increment subchunks counter
                            chunkList[myChunk].subchunks += 1;
                        } else {
                            // create array so buffer.slice is available
                            var byteArrayKey = new Uint8Array(e.hexKey.length / 2);
                            // populate the array
                            for (var i = 0; i < e.hexKey.length; i += 2) {
                                byteArrayKey[i/2] = parseInt("0x" + e.hexKey.substr(i, 2), 16);
                            }
                            chunkList[myChunk] = {
                                "subchunks": 1,
                                "x": new Int32Array((new Uint8Array(byteArrayKey)).buffer.slice(0,4))[0],
                                "z": new Int32Array((new Uint8Array(byteArrayKey)).buffer.slice(4,8))[0]
                            };
                        }
                    }
                });
                let chunkArray = [];
                for (let prop in chunkList) {
                        chunkList[prop]["hexKey"] = prop;
                        chunkArray.push(chunkList[prop]);
                }
                let unitSize = 16
                let xMin = Math.min(...chunkArray.map(x => x.x)) * unitSize;
                let zMin = Math.min(...chunkArray.map(x => x.z)) * unitSize;
                let xSize = Math.max(...chunkArray.map(x => x.x)) * unitSize - xMin;
                let zSize = Math.max(...chunkArray.map(x => x.z)) * unitSize - zMin;
                let svg = d3.select("svg#overWorld")
                    .attr("viewBox", xMin.toString(10) + " " + zMin.toString(10)+ " " + xSize.toString(10)+ " " + zSize.toString(10))
                    .attr("preserveAspectRatio", "xMidYMid meet")
                    // .attr("width", "800")
                    .attr("height", "auto")
                    ;
                let chunks = svg.selectAll("g")
                    .data(chunkArray)
                    .enter()
                    .append("g")
                    ;
                chunks.append("title")
                    .text(function(e){ return `${e.hexKey}\nchunk x,z ${e.x}, ${e.z}\nworld x,z ${e.x * 16}, ${e.z * 16}` ; })
                    ;
                chunks.append("rect")
                    .attr("x", function(e){ return e.x * unitSize; })
                    .attr("y", function(e){ return e.z * unitSize; })
                    .attr("width", function(e){ return unitSize *0.8; })
                    .attr("height", function(e){ return unitSize *0.8; })
                    ;
                
            });
        })();
    </script>
</body>
</html>